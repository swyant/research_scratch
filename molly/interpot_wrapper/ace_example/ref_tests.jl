using CSV, DataFrames
using AtomsIO

include("../v2_molly_interpot_utils.jl")


#### Nonorthog HfO2 
ace_hfo2 = ACE(species            = [:Hf, :O],
               body_order         = 4, 
               polynomial_degree  = 10,
               wL                 = 1.5, 
               csp                = 1.0,
               r0                 = 2.15,
               rcutoff            = 5.0)

coeffs_hfo2 = vec(Matrix(CSV.read("./N3_rcut5_maxdeg10_1e-3lambdaQR_fit_coeffs.csv",DataFrame,header=false)))

lb_hfo2 = LBasisPotential(coeffs_hfo2,[0.0],ace_hfo2)

inter_ace_hfo2 = InteratomicPotentialInter(lb_hfo2,u"eV", u"Å")
general_inters_hfo2 = (inter_ace_hfo2,)

sys_hfo2 = load_system("nonorthog_hfo2.xyz")

f_check_hfo2 = Molly.forces(inter_ace_hfo2, sys_hfo2)
#=
 [0.007883776209837379 eV Å⁻¹, -0.49108165224828326 eV Å⁻¹, 1.1671054093569637 eV Å⁻¹]
 [-0.6659899624841046 eV Å⁻¹, -0.8351559338315155 eV Å⁻¹, -1.4370534271501754 eV Å⁻¹]
 [-0.7335300097845447 eV Å⁻¹, 0.742405852541566 eV Å⁻¹, 0.5784871675186878 eV Å⁻¹]
 [-0.5403925540947512 eV Å⁻¹, 0.005798786236084652 eV Å⁻¹, 0.16854479892475638 eV Å⁻¹]
 [-0.44635788772984597 eV Å⁻¹, 0.7241443549982591 eV Å⁻¹, 0.7512537255622647 eV Å⁻¹]
 [0.4576460541557026 eV Å⁻¹, -0.36193973789926304 eV Å⁻¹, -1.686701897088426 eV Å⁻¹]
 [0.7474455989816988 eV Å⁻¹, 0.5637095770654241 eV Å⁻¹, -0.8714319778199524 eV Å⁻¹]
 [-0.6690080855807992 eV Å⁻¹, -0.5353887681732488 eV Å⁻¹, 0.5962576292293988 eV Å⁻¹]
 [0.1970655459028876 eV Å⁻¹, -0.10031819570858147 eV Å⁻¹, 0.02082358330526546 eV Å⁻¹]
 ⋮
 [0.48218926764659154 eV Å⁻¹, 0.1459809558442251 eV Å⁻¹, 0.251617373272658 eV Å⁻¹]
 [-1.1263254243895486 eV Å⁻¹, -0.572016408957609 eV Å⁻¹, 0.09737724104319559 eV Å⁻¹]
 [0.8336027673553698 eV Å⁻¹, 0.20645404150087887 eV Å⁻¹, 1.2550215294896887 eV Å⁻¹]
 [-0.26753026489580334 eV Å⁻¹, -0.5466633686286073 eV Å⁻¹, 0.11917240851337835 eV Å⁻¹]
 [0.831873527491979 eV Å⁻¹, -0.23000045857818335 eV Å⁻¹, 0.3225082262892006 eV Å⁻¹]
 [-0.2458247874387025 eV Å⁻¹, -0.7526457816552747 eV Å⁻¹, 0.45978289842127407 eV Å⁻¹]
 [0.558267553135587 eV Å⁻¹, 0.19998890598358463 eV Å⁻¹, 0.7723339949574409 eV Å⁻¹]
 [0.7215400682025408 eV Å⁻¹, 0.5390925193421678 eV Å⁻¹, 0.9147467229175821 eV Å⁻¹]
 =#
mp_hfo2 = molly_params(sys_hfo2)
m_sys_hfo2 = System(;mp_hfo2...,
            general_inters=general_inters_hfo2, 
            loggers=(force=ForceLogger(typeof(1.0u"eV/Å"), 1),),
            force_units=u"eV/Å",
            energy_units=u"eV",
            )

simulator = VelocityVerlet(
    dt=0.001u"ps",
    coupling=AndersenThermostat(80u"K", 1.0u"ps"),
)

simulate!(m_sys_hfo2,simulator,0)
f0_hfo2 = m_sys_hfo2.loggers.force.history[1]
#=
 [0.007883776209837379 eV Å⁻¹, -0.49108165224828326 eV Å⁻¹, 1.1671054093569637 eV Å⁻¹]
 [-0.6659899624841046 eV Å⁻¹, -0.8351559338315155 eV Å⁻¹, -1.4370534271501754 eV Å⁻¹]
 [-0.7335300097845447 eV Å⁻¹, 0.742405852541566 eV Å⁻¹, 0.5784871675186878 eV Å⁻¹]
 [-0.5403925540947512 eV Å⁻¹, 0.005798786236084652 eV Å⁻¹, 0.16854479892475638 eV Å⁻¹]
 [-0.44635788772984597 eV Å⁻¹, 0.7241443549982591 eV Å⁻¹, 0.7512537255622647 eV Å⁻¹]
 [0.4576460541557026 eV Å⁻¹, -0.36193973789926304 eV Å⁻¹, -1.686701897088426 eV Å⁻¹]
 [0.7474455989816988 eV Å⁻¹, 0.5637095770654241 eV Å⁻¹, -0.8714319778199524 eV Å⁻¹]
 [-0.6690080855807992 eV Å⁻¹, -0.5353887681732488 eV Å⁻¹, 0.5962576292293988 eV Å⁻¹]
 [0.1970655459028876 eV Å⁻¹, -0.10031819570858147 eV Å⁻¹, 0.02082358330526546 eV Å⁻¹]
 ⋮
 [0.48218926764659154 eV Å⁻¹, 0.1459809558442251 eV Å⁻¹, 0.251617373272658 eV Å⁻¹]
 [-1.1263254243895486 eV Å⁻¹, -0.572016408957609 eV Å⁻¹, 0.09737724104319559 eV Å⁻¹]
 [0.8336027673553698 eV Å⁻¹, 0.20645404150087887 eV Å⁻¹, 1.2550215294896887 eV Å⁻¹]
 [-0.26753026489580334 eV Å⁻¹, -0.5466633686286073 eV Å⁻¹, 0.11917240851337835 eV Å⁻¹]
 [0.831873527491979 eV Å⁻¹, -0.23000045857818335 eV Å⁻¹, 0.3225082262892006 eV Å⁻¹]
 [-0.2458247874387025 eV Å⁻¹, -0.7526457816552747 eV Å⁻¹, 0.45978289842127407 eV Å⁻¹]
 [0.558267553135587 eV Å⁻¹, 0.19998890598358463 eV Å⁻¹, 0.7723339949574409 eV Å⁻¹]
 [0.7215400682025408 eV Å⁻¹, 0.5390925193421678 eV Å⁻¹, 0.9147467229175821 eV Å⁻¹]
 =#


##### Nonorthog TiAl
ace_tial = ACE(species           = [:Ti, :Al],
              body_order        = 3,
              polynomial_degree = 6,
              wL                = 1.5,
              csp               = 1.0,
              r0                = 2.9,
              rcutoff           = 5.5 )

coeffs_tial = [0.025591381519026762, 0.03527125788791906, 0.030612348271342734, 0.06646319273427727, -0.007326117584533097, 0.0021476223879284516, 0.007005564677788114, 0.007769244005502122, 0.0033019143419533176, -0.024266397752728517, -0.03511058549188825, -0.004486106026460792, 0.07649832144216986, -0.017295005584346018, 0.0348519410800185, -0.0026935081045876344, -0.0036996351104090115, 0.04250332320742131, -0.06611126598243479, 0.07452744399669442, -0.08807382022058645, 0.006553101218837121, -0.02825330387435087, -0.005070437887508557, 0.017488241826946662, -0.041461388491636234, -0.050152804966179194, 0.014554551186620662, 0.005494466857846328, 0.03395869840669037, -0.12004390275966798, 0.07758118243125994, 0.024624168020804672, 0.0006581992277555695, -0.002196641935532242, 0.03231551745953874, 0.0005431753297032715, 0.009602374511533056, 0.028907266845791348, 0.03557855646347803, 0.000832998634326787, 0.019238505326450918, -0.007863457928993406, 0.03497657242548427, -0.058485491203844206, -0.025527625067137013, -0.003851837725125408, 0.019472633328804008, -0.04975455754968226, 0.008243807089528446, 0.020612783411412677, -0.07411984524326856, 0.007005564677788615, 0.0077692440055020795, 0.003301914341951156, -0.024266397752728874, -0.03511058549188732, -0.004486106026461139, 0.004050167320520888, 0.011275083723136878, -0.009533633282696359, -0.016652089366136488, 0.005947187981081792, -0.0086386178798077, 0.027556838876613178, -0.01794755394550558, 0.0328518497817209, -0.0444008944069233, -0.04142464521909121, 0.014939466653767677, -0.0013061815492572404, -0.008399904141687925, -0.013070571180237286, 0.07022679858374972, 0.03655463426663164, -0.02425878114877371, -0.013089322405632224, 0.007663504514768707, -0.0006932536563853398, -0.015392489165582057, -0.005333834581033578, 0.000966860983206308, -0.06259246382383571, 0.04896321372972445, -0.012976299346956766, 0.00575471543255263, -0.010710826925328487, 0.009130893987440367, 0.025455356200891677, 0.03737467186835743, -0.061410072131176816, 0.05891873535070835, 0.02179281899408886, 0.02640823532251172, 0.0002904232787473565, -0.028649695323579742, -0.018788426151163752, -0.004911376520223526, 0.034242726688142995, -0.008960425717451335, -0.04627434272845332, 0.05321984323617818, 0.013802856612787245, 0.023560957961937884]



lb_tial = LBasisPotential(coeffs_tial,[0.0],ace_tial)

inter_ace_tial = InteratomicPotentialInter(lb_tial,u"eV", u"Å")
general_inters_tial = (inter_ace_tial,)

#sys_tial = load_system("./nonorthog_TiAl_example.xyz")
sys_tial = load_system("./alt_nonorthog_TiAl_example.xyz")

f_check_tial = Molly.forces(inter_ace_tial, sys_tial)
#=
 [-0.4461309280449358 eV Å⁻¹, 0.5403359378738349 eV Å⁻¹, -0.1331972765358 eV Å⁻¹]
 [0.4461309280449358 eV Å⁻¹, -0.5403359378738349 eV Å⁻¹, 0.13319727653580002 eV Å⁻¹]
=#
mp_tial = molly_params(sys_tial)
m_sys_tial = System(;mp_tial...,
            general_inters=general_inters_tial, 
            loggers=(force=ForceLogger(typeof(1.0u"eV/Å"), 1),),
            force_units=u"eV/Å",
            energy_units=u"eV",
            )


simulate!(m_sys_tial,simulator,0)
f0_tial = m_sys_tial.loggers.force.history[1]
#=
 [-0.44613092804493704 eV Å⁻¹, 0.5403359378738343 eV Å⁻¹, -0.13319727653579982 eV Å⁻¹]
 [0.44613092804493704 eV Å⁻¹, -0.5403359378738343 eV Å⁻¹, 0.13319727653579982 eV Å⁻¹]
=#

